<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Data</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.0"></script>
    <style>
        .plotly-graph-div { border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-8">
    <div class="w-full max-w-5xl mx-auto px-2 md:px-6">
        <div class="bg-white shadow-xl rounded-2xl p-6 md:p-10 mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-microchip text-indigo-500"></i>
                        {{ device.device_name }}
                    </h1>
                    <div class="flex items-center mt-2 text-gray-600 text-sm gap-4 flex-wrap">
                        <span>Device ID: <span class="font-mono text-gray-800">{{ device.device_id }}</span></span>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold
                            {% if device.device_status == 'online' %}bg-green-100 text-green-700
                            {% else %}bg-red-100 text-red-700{% endif %}">
                            {{ device.device_status|title }}
                        </span>
                    </div>
                </div>
                <a href="{% if request.GET.from == 'admin_dashboard' %}{% url 'admin_dashboard' %}{% elif request.GET.from == 'device_admin_dashboard' %}{% url 'device_admin_dashboard' %}{% else %}{% url 'user_dashboard' %}{% endif %}"
                   class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-indigo-50 hover:text-indigo-700 transition">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Dashboard
                </a>
            </div>

            <div class="mb-6">
                <label for="timeRange" class="block text-sm font-medium text-gray-700 mb-1">Time Range</label>
                <select id="timeRange" name="timeRange" class="mt-1 block w-full md:w-64 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="10_latest" selected>Last 10 Entries</option>
                    <option value="1_hour">Last 1 Hour</option>
                    <option value="6_hour">Last 6 Hours</option>
                    <option value="12_hour">Last 12 Hours</option>
                    <option value="1_day">Last 24 Hours</option>
                    <option value="1_week">Last Week</option>
                    <option value="2_weeks">Last 2 Weeks</option>
                    <option value="1_month">Last Month</option>
                    <option value="3_months">Last 3 Months</option>
                    <option value="6_months">Last 6 Months</option>
                    <option value="1_year">Last Year</option>
                    <option value="5_years">Last 5 Years</option>
                    <option value="all">All Time</option>
                </select>
            </div>

            {% if error %}
            <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6 rounded-lg">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700">{{ error }}</p>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if data %}
            <div class="bg-gray-50 shadow-inner rounded-xl p-4 md:p-8 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-line text-indigo-400"></i> Device Metrics
                </h2>
                <div id="chart" class="w-full" style="min-height:350px;"></div>
            </div>

            <div class="bg-white shadow rounded-xl p-4 md:p-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-table text-indigo-400"></i> Raw Data
                </h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                {% for field in data.0.keys %}
                                    {% if field != 'device_id' and field != 'status' and field != 'timestamp' %}
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ field }}</th>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for entry in data %}
                            <tr class="hover:bg-indigo-50 transition">
                                <td class="px-6 py-4 whitespace-nowrap text-gray-700">
                                    <span class="timestamp" data-timestamp="{{ entry.timestamp }}"></span>
                                </td>
                                {% for field, value in entry.items %}
                                    {% if field != 'device_id' and field != 'status' and field != 'timestamp' %}
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">{{ value }}</td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <!-- Pagination Controls -->
                    <div class="mt-4 flex flex-col md:flex-row justify-center items-center space-y-2 md:space-y-0 md:space-x-4">
                        {% if has_previous %}
                        <a href="?timeRange={{ time_range }}&page={{ current_page|add:'-1' }}{% if request.GET.from %}&from={{ request.GET.from }}{% endif %}"
                           class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">Previous</a>
                        {% endif %}
                        <span class="px-4 py-2 text-gray-600">Page {{ current_page }} of {{ total_pages }}</span>
                        {% if has_next %}
                        <a href="?timeRange={{ time_range }}&page={{ current_page|add:'1' }}{% if request.GET.from %}&from={{ request.GET.from }}{% endif %}"
                           class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">Next</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
    document.getElementById('timeRange').addEventListener('change', function() {
        const timeRange = this.value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('timeRange', timeRange);
        currentUrl.searchParams.set('page', '1'); // Reset to first page when changing time range
        // Preserve 'from' param if present
        const fromParam = currentUrl.searchParams.get('from');
        if (fromParam) {
            currentUrl.searchParams.set('from', fromParam);
        }
        window.location.href = currentUrl.toString();
    });

    // Format timestamps
    document.querySelectorAll('.timestamp').forEach(element => {
        const timestamp = new Date(element.dataset.timestamp);
        element.textContent = timestamp.toLocaleString();
    });

    {% if data %}
    // Prepare data for Plotly
    const traces = [];
    const colors = ['#00ff00', '#ff0000', '#0000ff', '#ff00ff', '#00ffff', '#ffff00', '#ff8000', '#8000ff', '#008080', '#800080'];
    
    const plotData = {{ plot_data|safe }};
    Object.entries(plotData).forEach(([field, data], index) => {
        traces.push({
            x: data.timestamps,
            y: data.values,
            name: field.charAt(0).toUpperCase() + field.slice(1).replace(/_/g, ' '),
            type: 'scatter',
            mode: 'lines',
            line: {
                width: 2.5,
                color: colors[index % colors.length],
                shape: 'linear',
                smoothing: 0.3
            },
            hoverlabel: {
                bgcolor: '#2c3e50',
                font: { family: 'Arial', size: 14, color: '#ffffff' }
            },
            hovertemplate: '<b>%{x}</b><br>' +
                          '<b>%{y:.2f}</b><br>' +
                          '<extra></extra>'
        });
    });

    const layout = {
        title: {
            text: 'Device Data - {{ time_range }}',
            font: {
                family: 'Arial',
                size: 24,
                color: '#2c3e50'
            },
            x: 0.5,
            xanchor: 'center'
        },
        height: 600,
        showlegend: true,
        hovermode: 'x unified',
        xaxis: {
            title: {
                text: 'Time',
                font: {
                    family: 'Arial',
                    size: 14,
                    color: '#2c3e50'
                }
            },
            rangeslider: { 
                visible: true,
                thickness: 0.1,
                bgcolor: '#f8f9fa'
            },
            type: 'date',
            rangeselector: {
                buttons: [
                    {count: 1, label: '1H', step: 'hour', stepmode: 'backward'},
                    {count: 4, label: '4H', step: 'hour', stepmode: 'backward'},
                    {count: 12, label: '12H', step: 'hour', stepmode: 'backward'},
                    {count: 1, label: '1D', step: 'day', stepmode: 'backward'},
                    {count: 7, label: '1W', step: 'day', stepmode: 'backward'},
                    {count: 1, label: '1M', step: 'month', stepmode: 'backward'},
                    {step: 'all', label: 'ALL'}
                ],
                bgcolor: '#f8f9fa',
                activecolor: '#2c3e50',
                font: {
                    family: 'Arial',
                    size: 12,
                    color: '#2c3e50'
                }
            },
            gridcolor: '#e9ecef',
            zerolinecolor: '#e9ecef',
            showgrid: true,
            showspikes: true,
            spikemode: 'across',
            spikesnap: 'cursor',
            spikecolor: '#2c3e50',
            spikedash: 'solid',
            spikethickness: 1
        },
        yaxis: {
            title: {
                text: 'Value',
                font: {
                    family: 'Arial',
                    size: 14,
                    color: '#2c3e50'
                }
            },
            autorange: true,
            fixedrange: false,
            showgrid: true,
            zeroline: true,
            zerolinecolor: '#e9ecef',
            zerolinewidth: 1,
            gridcolor: '#e9ecef',
            showspikes: true,
            spikesnap: 'cursor',
            spikecolor: '#2c3e50',
            spikedash: 'solid',
            spikethickness: 1
        },
        legend: {
            orientation: 'h',
            yanchor: 'bottom',
            y: 1.02,
            xanchor: 'right',
            x: 1,
            bgcolor: '#f8f9fa',
            bordercolor: '#e9ecef',
            borderwidth: 1,
            font: {
                family: 'Arial',
                size: 12,
                color: '#2c3e50'
            }
        },
        plot_bgcolor: '#ffffff',
        paper_bgcolor: '#ffffff',
        font: {
            family: 'Arial',
            size: 12,
            color: '#2c3e50'
        },
        margin: {
            l: 50,
            r: 50,
            t: 80,
            b: 50,
            pad: 4
        },
        hoverdistance: 100,
        spikedistance: 1000
    };

    const config = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false,
        modeBarButtonsToAdd: [
            'drawline',
            'drawopenpath',
            'eraseshape',
            'zoom2d',
            'pan2d',
            'select2d',
            'lasso2d',
            'zoomIn2d',
            'zoomOut2d',
            'autoScale2d',
            'resetScale2d'
        ],
        modeBarButtonsToRemove: ['toggleSpikelines'],
        scrollZoom: true,
        showTips: true,
        showLink: false,
        toImageButtonOptions: {
            format: 'png',
            filename: 'device_data_chart',
            height: 800,
            width: 1200,
            scale: 2
        }
    };

    Plotly.newPlot('chart', traces, layout, config);

    // Add custom zoom controls
    const chartDiv = document.getElementById('chart');
    const zoomControls = document.createElement('div');
    zoomControls.className = 'zoom-controls';
    zoomControls.style.cssText = `
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: #f8f9fa;
        padding: 5px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    `;
    
    const zoomInBtn = document.createElement('button');
    zoomInBtn.innerHTML = '+';
    zoomInBtn.className = 'zoom-btn';
    zoomInBtn.style.cssText = `
        padding: 5px 10px;
        margin: 0 2px;
        border: none;
        background: #2c3e50;
        color: white;
        border-radius: 4px;
        cursor: pointer;
    `;
    
    const zoomOutBtn = document.createElement('button');
    zoomOutBtn.innerHTML = '-';
    zoomOutBtn.className = 'zoom-btn';
    zoomOutBtn.style.cssText = zoomInBtn.style.cssText;
    
    zoomControls.appendChild(zoomOutBtn);
    zoomControls.appendChild(zoomInBtn);
    chartDiv.appendChild(zoomControls);
    
    zoomInBtn.onclick = () => {
        const update = {
            'xaxis.autorange': false,
            'yaxis.autorange': false
        };
        Plotly.relayout(chartDiv, update);
        Plotly.zoom(chartDiv, 1.5);
    };
    
    zoomOutBtn.onclick = () => {
        const update = {
            'xaxis.autorange': false,
            'yaxis.autorange': false
        };
        Plotly.relayout(chartDiv, update);
        Plotly.zoom(chartDiv, 0.75);
    };
    {% endif %}

    // WebSocket connection for live updates
    let ws = null;
    let deviceId = '{{ device.device_id }}';
    
    function connectWebSocket() {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/device_data/${deviceId}/`;
        
        ws = new WebSocket(wsUrl);
        
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                updateDeviceData(data);
            } catch (error) {
                console.error('Error parsing WebSocket data:', error);
            }
        };
        
        ws.onclose = function() {
            console.log('WebSocket connection closed. Reconnecting...');
            setTimeout(connectWebSocket, 5000);
        };

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    }
    
    function updateDeviceData(newData) {
        try {
            // Update the table
            const tbody = document.querySelector('table tbody');
            if (!tbody) return;

            const newRow = document.createElement('tr');
            newRow.className = 'hover:bg-gray-50';
            
            // Create timestamp cell
            const timestampCell = document.createElement('td');
            timestampCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
            timestampCell.innerHTML = `<span class="timestamp" data-timestamp="${newData.timestamp}"></span>`;
            newRow.appendChild(timestampCell);
            
            // Create data cells
            for (const [field, value] of Object.entries(newData)) {
                if (field !== 'device_id' && field !== 'status' && field !== 'timestamp') {
                    const cell = document.createElement('td');
                    cell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    cell.textContent = value;
                    newRow.appendChild(cell);
                }
            }
            
            // Add new row at the top
            tbody.insertBefore(newRow, tbody.firstChild);
            
            // Remove oldest row if more than 10 rows
            if (tbody.children.length > 10) {
                tbody.removeChild(tbody.lastChild);
            }
            
            // Update the chart
            updateChart(newData);
        } catch (error) {
            console.error('Error updating device data:', error);
        }
    }
    
    function updateChart(newData) {
        try {
            const plotData = {{ plot_data|safe }};
            
            // Update each trace with new data
            Object.entries(plotData).forEach(([field, data], index) => {
                if (field in newData) {
                    data.timestamps.push(newData.timestamp);
                    data.values.push(newData[field]);
                    
                    // Keep only last 10 points
                    if (data.timestamps.length > 10) {
                        data.timestamps.shift();
                        data.values.shift();
                    }
                    
                    // Update the trace
                    Plotly.update('chart', {
                        x: [data.timestamps],
                        y: [data.values]
                    }, [index]);
                }
            });
        } catch (error) {
            console.error('Error updating chart:', error);
        }
    }
    
    // Initialize WebSocket connection when page loads
    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
        
        // Format timestamps
        document.querySelectorAll('.timestamp').forEach(function(element) {
            const timestamp = new Date(element.dataset.timestamp);
            element.textContent = timestamp.toLocaleString();
        });
    });
    </script>
</body>
</html> 